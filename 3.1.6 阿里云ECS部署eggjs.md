# 3.1.6 阿里云ECS部署eggjs


## 1.云服务器购买设置

```
1.点击立即购买按钮，进入确认订单页面，这里选择自定义密码，设置 ssh 登录密码，后面要用，请牢记此密码,进入主机必须有的

2.购买好以后，进入控制台，左侧功能栏选择云服务器ECS,点击 进入 即可获取服务器的`公网地址`
```

## 2.登陆服务器 SSH

>SSH之所以能够保证安全，原因在于它采用了公钥加密。

- [SSH原理与运用](http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html)
- [数字签名是什么](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)
  - 在双钥体系中，公钥用来加密信息，私钥用来数字签名
  - 对公钥和一些相关信息一起加密，生成"数字证书"（Digital Certificate）。

1.打开本地终端,bash 或者 xshell 或者 SecureCRT

```
1.输入 ssh root@公网IP  (如: ssh root@40.47.89.123)

2.提示输入密码(就是上面设置的ssh登录密码)

3.上述操作是使用 root 用户身份登陆，会直接进入到下图 root 目录下。

4. 先 cd .. 跳转到上一层, 再 ls -a ，就可以看到linux的目录结构了。
```

![](http://kovli.oss-cn-shanghai.aliyuncs.com/blog/ecs2.jpg)

图片引用自《鸟哥的Linux》


## 3.安装Nginx

1. 在配置 nginx 时，可能会依赖于 PCRE 包和 zlib 包，先进行安装：

先 `cd /usr/local` 切换目录

```
cd /usr/local
yum -y install pcre pcre-devel
yum install -y zlib-devel

```

2. 下载 nginx，这里nginx版本号可以根据需要选择，我选择	nginx-1.17.2 是当时最新的版本了，下面的node版本、mongodb版本都可以根据自己的需要选择

- [nginx官网版本列表](http://nginx.org/)

```
cd /usr/local/src 

wget http://nginx.org/download/nginx-1.17.2.tar.gz
```

3. 解压缩

```
tar -xvzf nginx-1.17.2.tar.gz
```

4. 配置nginx

下载解压 openssl, 最后找较新版本,

```
wget https://www.openssl.org/source/openssl-1.0.2l.tar.gz

tar -xvzf openssl-1.0.2l.tar.gz
```

cd 进入nginx解压包里，执行之前安装的pcre-devel与openssl-devel解决依赖问题

```
cd nginx-1.17.2
yum -y install pcre-devel openssl openssl-devel
```

再执行配置脚本来进行编译预处理

```
./configure --prefix=/usr/local/nginx --conf-path=/usr/local/nginx/nginx.conf --with-http_stub_status_module --with-http_gzip_static_module --with-http_ssl_module --with-openssl=/usr/local/src/openssl-1.0.2l
```

成功后显示如下信息，

```
Configuration summary
  + using system PCRE library
  + using OpenSSL library: /usr/local/src/openssl-1.0.2l
  + using system zlib library

  nginx path prefix: "/usr/local/nginx"
  nginx binary file: "/usr/local/nginx/sbin/nginx"
  nginx modules path: "/usr/local/nginx/modules"
  nginx configuration prefix: "/usr/local/nginx"
  nginx configuration file: "/usr/local/nginx/nginx.conf"
  nginx pid file: "/usr/local/nginx/logs/nginx.pid"
  nginx error log file: "/usr/local/nginx/logs/error.log"
  nginx http access log file: "/usr/local/nginx/logs/access.log"
  nginx http client request body temporary files: "client_body_temp"
  nginx http proxy temporary files: "proxy_temp"
  nginx http fastcgi temporary files: "fastcgi_temp"
  nginx http uwsgi temporary files: "uwsgi_temp"
  nginx http scgi temporary files: "scgi_temp"
```

make

```
make && make install
```


5. 使用 openssl 生成证书（以下介绍的是自己生成的供学习用，正常面向市场的产品请用认证的）

```
openssl req -new -x509 -nodes -out server.crt -keyout server.key
```

移动证书到nginx文件夹

```
mv server.crt /usr/local/nginx
mv server.key /usr/local/nginx
```

认证的SSL证书，申请阿里云免费ssl证书：(申请后需要先买好域名),验证配置后下载证书,可通过 ftp工具 放到ECS服务器

[如何申请免费SSL证书 - 阿里云云盾证书](https://bbs.aliyun.com/read/573933.html?spm=5176.10695662.1996646101.searchclickresult.620e1cb9tYLx7m)

操作技巧：想看到免费的证书，品牌选择Symantec，证书类型选择免费型DV SSL



6. 修改 nginx 配置文件：

```
vi /usr/local/nginx/nginx.conf
```

修改如下

```
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    # 关闭错误页面的nginx版本数字，提高安全性
    server_tokens off;

    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    include /usr/local/nginx/sites-enabled-server/*;


}
```

新建文件夹用于存放多网站的nginx配置文件

```
cd /usr/local/nginx/
mkdir sites-enabled-server
sites-enabled-server里面新增若干文件，以便这个ECS可以给多网站使用
```

vim default

```
server {
        listen 80;
        server_name _;

        return 404;
}

server {
        listen       80;
        server_name  你的域名.com www.你的域名.com;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            proxy_pass http://127.0.0.1:nodejs配置的端口号;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}
        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }

    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}
```
vim default-ssl

```
server {
        listen       443 ssl;
        server_name  localhost;

        ssl_certificate      server.crt;
        ssl_certificate_key  server.key;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        location / {
             proxy_pass http://127.0.0.1:nodejs配置的端口号;
        }
    }

```

继续新增网站，例如，vim mywebsite.cn

```
server {
        listen       80;
        server_name  mywebsite.cn www.mywebsite.cn;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            proxy_pass http://127.0.0.1:nodejs配置的mywebsite的端口号;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }
```
7. 启动nginx

```
/usr/local/nginx/sbin/nginx
```

## 4. 安装 node

- node – 编译后二进制文件应在`/usr/local/bin/node` 下

- mongodb – 安装在`/usr/local/mongodb` 下

下面就一步一步来

1. 首先升级CentOS

```
yum -y update
```

2. 升级后，跳转到 `/usr/local/src `, 这个文件夹通常用来存放软件源代码

```
cd /usr/local/src
```

## 参考
- [阿里云ECS服务器部署Node.js项目全过程详解](http://www.kovli.com/2017/09/19/ecs-deploy/)
